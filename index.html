// server.js
const express = require('express');
const bodyParser = require('body-parser');
const path = require('path');

const app = express();
app.use(bodyParser.json());

// เก็บ OTP ชั่วคราว
const otpStore = {};

// เสิร์ฟหน้าเว็บ HTML แบบง่าย ๆ
app.get('/', (req, res) => {
  res.send(`
<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ลงทะเบียนพร้อม OTP จำลอง</title>
<style>
  body {
    font-family: 'Sarabun', sans-serif;
    max-width: 400px;
    margin: 50px auto;
    padding: 20px;
    background: #e8f5e9;
    border-radius: 10px;
    box-shadow: 0 0 15px rgba(0,0,0,0.1);
  }
  input, button {
    width: 100%;
    padding: 12px;
    margin: 10px 0;
    font-size: 1em;
  }
  button {
    background-color: #4caf50;
    color: white;
    border: none;
    cursor: pointer;
  }
  button:hover {
    background-color: #388e3c;
  }
  #otp-section {
    display: none;
  }
  #message {
    margin-top: 15px;
    font-weight: bold;
  }
</style>
</head>
<body>

<h2>ลงทะเบียนด้วยเบอร์โทร (ระบบจำลอง OTP)</h2>

<input type="tel" id="phone" placeholder="เบอร์โทรศัพท์" />
<button onclick="sendOTP()">ขอรหัส OTP</button>

<div id="otp-section">
  <input type="text" id="otp" placeholder="กรอกรหัส OTP" />
  <button onclick="verifyOTP()">ยืนยัน OTP</button>
</div>

<p id="message"></p>

<script>
  async function sendOTP() {
    const phone = document.getElementById('phone').value.trim();
    if (!phone) {
      alert('กรุณากรอกเบอร์โทรให้ถูกต้อง');
      return;
    }
    const res = await fetch('/send-otp', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ phone })
    });
    const data = await res.json();
    document.getElementById('message').innerText = data.message;
    if (data.success) {
      document.getElementById('otp-section').style.display = 'block';
    }
  }

  async function verifyOTP() {
    const phone = document.getElementById('phone').value.trim();
    const otp = document.getElementById('otp').value.trim();
    if (!otp) {
      alert('กรุณากรอกรหัส OTP');
      return;
    }
    const res = await fetch('/verify-otp', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ phone, otp })
    });
    const data = await res.json();
    document.getElementById('message').innerText = data.message;
  }
</script>

</body>
</html>
  `);
});

// API ส่ง OTP (จำลอง)
app.post('/send-otp', (req, res) => {
  const { phone } = req.body;
  if (!phone) {
    return res.json({ success: false, message: 'กรุณากรอกเบอร์โทร' });
  }
  const otp = Math.floor(100000 + Math.random() * 900000).toString();
  otpStore[phone] = otp;
  console.log(`ส่ง OTP ให้เบอร์ ${phone} คือ ${otp}`); // แสดง OTP ใน console เพื่อทดสอบ
  res.json({ success: true, message: 'ส่งรหัส OTP แล้ว (ดูรหัสใน console)' });
});

// API ตรวจสอบ OTP
app.post('/verify-otp', (req, res) => {
  const { phone, otp } = req.body;
  if (!phone || !otp) {
    return res.json({ success: false, message: 'ข้อมูลไม่ครบถ้วน' });
  }
  const validOtp = otpStore[phone];
  if (validOtp && validOtp === otp) {
    delete otpStore[phone];
    res.json({ success: true, message: 'ยืนยัน OTP สำเร็จ!' });
  } else {
    res.json({ success: false, message: 'รหัส OTP ไม่ถูกต้อง' });
  }
});

const PORT = 3000;
app.listen(PORT, () => {
  console.log(`Server running at http://localhost:${PORT}`);
});
